name: DevSecOps CI/CD pipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  # ✅ MUST be lowercase for GHCR
  GHCR_REGISTRY: ghcr.io
  IMAGE_OWNER: daudamin12
  IMAGE_REPO: devsecops-app
  IMAGE_TAG: latest

jobs:
  build_scan_push_deploy:
    name: Build + Scan + Push + Deploy
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print version
        run: |
          echo "VERSION=${{ env.IMAGE_TAG }}"
          echo "IMAGE=${{ env.GHCR_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}"

      # ✅ Recommended: Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ✅ Login to GHCR (uses your repo secret GHCR_PAT)
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ env.IMAGE_OWNER }}
          password: ${{ secrets.GHCR_PAT }}

      # ✅ Build image locally (tagged)
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.GHCR_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} ./app

      # ✅ Trivy scan (fails pipeline on HIGH/CRITICAL)
      - name: Scan Image with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.GHCR_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      # ✅ Push to GHCR
      - name: Push Image to GHCR
        run: |
          docker push ${{ env.GHCR_REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

      # ✅ Deploy to Kubernetes (requires kubectl + cluster access on runner)
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/devsecops-app
